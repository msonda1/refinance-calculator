<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Refinancing Decision Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group small {
            color: #666;
            margin-top: 3px;
            font-size: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .reset-btn {
            background: #e0e0e0;
            color: #333;
        }
        
        .reset-btn:hover {
            background: #d0d0d0;
        }
        
        .results {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            display: none;
        }
        
        .results.show {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .results h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .result-label {
            font-weight: 600;
            color: #333;
        }
        
        .result-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }
        
        .decision-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
        }
        
        .decision-box.good {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .decision-box.bad {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }
        
        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
        }
        
        .info-box h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-box p {
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .breakeven-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            display: none;
        }
        
        .breakeven-section.show {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        .breakeven-section h2 {
            color: #1976d2;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .breakeven-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .breakeven-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .breakeven-card h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 10px;
        }
        
        .breakeven-detail {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .breakeven-label {
            color: #555;
            font-size: 14px;
        }
        
        .breakeven-value {
            font-weight: 700;
            font-size: 16px;
            color: #1976d2;
        }
        
        .rate-highlight {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
        }
        
        .rate-highlight .rate {
            font-size: 28px;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .rate-highlight .label {
            font-size: 14px;
            opacity: 0.95;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .loading.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .breakeven-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Mortgage Refinancing Decision Calculator</h1>
            <p>Analyze if refinancing your mortgage makes financial sense</p>
        </div>
        
        <div class="content">
            <div class="section">
                <h2>üè† Current Loan Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentBalance">Current Loan Balance ($)</label>
                        <input type="number" id="currentBalance" step="1000" placeholder="e.g., 250000">
                    </div>
                    <div class="form-group">
                        <label for="currentRate">Current Interest Rate (%)</label>
                        <input type="number" id="currentRate" step="0.01" placeholder="e.g., 6.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="yearsRemaining">Years Remaining on Current Loan</label>
                        <input type="number" id="yearsRemaining" step="1" placeholder="e.g., 20">
                    </div>
                    <div class="form-group">
                        <label for="currentPrepaymentPenalty">Prepayment Penalty (%)</label>
                        <input type="number" id="currentPrepaymentPenalty" step="0.1" value="0" placeholder="e.g., 0">
                        <small>Leave 0 if no penalty</small>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>üÜï New Loan Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newRate">New Interest Rate (%)</label>
                        <input type="number" id="newRate" step="0.01" placeholder="e.g., 3.5">
                    </div>
                    <div class="form-group">
                        <label for="newTerm">New Loan Term (years)</label>
                        <input type="number" id="newTerm" step="1" placeholder="e.g., 30">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="originationFee">Origination Fee (%)</label>
                        <input type="number" id="originationFee" step="0.1" value="1" placeholder="e.g., 1">
                    </div>
                    <div class="form-group">
                        <label for="points">Discount Points (%)</label>
                        <input type="number" id="points" step="0.1" value="0" placeholder="e.g., 2">
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>‚è±Ô∏è Analysis Period</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="holdingPeriod">Expected Holding Period (years)</label>
                        <input type="number" id="holdingPeriod" step="1" placeholder="e.g., 10">
                        <small>How long until you sell or pay off?</small>
                    </div>
                    <div class="form-group">
                        <label for="riskFreeRate">Benchmark Rate (%)</label>
                        <input type="number" id="riskFreeRate" step="0.01" placeholder="e.g., 4.0">
                        <small>Compare to T-Bill rate of similar term</small>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="calculate-btn" onclick="calculateRefinance()">Calculate Refinancing Analysis</button>
                <button class="reset-btn" onclick="resetForm()">Reset Form</button>
            </div>
            
            <div class="loading" id="loading">
                <p>Calculating break-even rates... Please wait...</p>
            </div>
            
            <div id="results" class="results">
                <h2>üìà Analysis Results</h2>
                <div id="resultsContent"></div>
            </div>
            
            <div id="breakevenSection" class="breakeven-section">
                <h2>üéØ Break-Even Rate Analysis</h2>
                <p style="margin-bottom: 20px; color: #555;">These are the maximum interest rates at which refinancing would still make financial sense based on your benchmark rate of <span id="benchmarkRateDisplay" style="font-weight: bold; color: #1976d2;"></span>.</p>
                <div class="breakeven-grid">
                    <div class="breakeven-card">
                        <h3>15-Year Loan</h3>
                        <div id="breakeven15Content"></div>
                    </div>
                    <div class="breakeven-card">
                        <h3>30-Year Loan</h3>
                        <div id="breakeven30Content"></div>
                    </div>
                </div>
            </div>
            
            <div class="info-box">
                <h3>üí° How to Use This Calculator</h3>
                <p><strong>Decision Rule:</strong> Refinancing is recommended when BOTH conditions are met: (1) The IRR exceeds your benchmark rate AND (2) The NPV is positive. The calculator accounts for all costs including prepayment penalties, origination fees, and discount points.</p>
                <p style="margin-top: 10px;"><strong>Break-Even Analysis:</strong> Shows the maximum interest rate you could accept for 15-year and 30-year loans while still achieving your target return. If you can get a rate below these thresholds, refinancing makes sense.</p>
            </div>
        </div>
    </div>
    
    <script>
        function calculateMonthlyPayment(principal, annualRate, months) {
            const monthlyRate = annualRate / 100 / 12;
            if (monthlyRate === 0) return principal / months;
            return principal * monthlyRate * Math.pow(1 + monthlyRate, months) / (Math.pow(1 + monthlyRate, months) - 1);
        }
        
        function calculateRemainingBalance(principal, annualRate, totalMonths, monthsPaid) {
            const monthlyRate = annualRate / 100 / 12;
            const payment = calculateMonthlyPayment(principal, annualRate, totalMonths);
            const monthsRemaining = totalMonths - monthsPaid;
            
            if (monthlyRate === 0) return principal * (monthsRemaining / totalMonths);
            
            return payment * (Math.pow(1 + monthlyRate, monthsRemaining) - 1) / (monthlyRate * Math.pow(1 + monthlyRate, monthsRemaining));
        }
        
        function calculateIRR(cashFlows) {
            // Check if we have valid cash flows for IRR calculation
            let hasPositive = false;
            let hasNegative = false;
            for (let cf of cashFlows) {
                if (cf > 0) hasPositive = true;
                if (cf < 0) hasNegative = true;
            }
            
            // IRR requires at least one positive and one negative cash flow
            if (!hasPositive || !hasNegative) {
                return null;
            }
            
            const maxIterations = 1000;
            const tolerance = 0.0001;
            let rate = 0.1;
            
            for (let i = 0; i < maxIterations; i++) {
                let npv = 0;
                let dnpv = 0;
                
                for (let t = 0; t < cashFlows.length; t++) {
                    npv += cashFlows[t] / Math.pow(1 + rate, t);
                    dnpv -= t * cashFlows[t] / Math.pow(1 + rate, t + 1);
                }
                
                if (Math.abs(dnpv) < tolerance) {
                    // Derivative too small, can't continue
                    return null;
                }
                
                const newRate = rate - npv / dnpv;
                
                if (Math.abs(newRate - rate) < tolerance) {
                    return newRate * 100;
                }
                
                // Bound the rate to prevent extreme values
                if (newRate < -0.99) {
                    rate = -0.99;
                } else if (newRate > 10) {
                    rate = 10;
                } else {
                    rate = newRate;
                }
            }
            
            // Did not converge
            return null;
        }
        
        function calculateBreakEvenRate(currentBalance, currentRate, yearsRemaining, newTermYears, 
                                       originationFee, points, currentPrepaymentPenalty, 
                                       holdingPeriod, targetIRR) {
            // Binary search for the break-even rate
            let lowRate = 0.01;
            let highRate = currentRate;
            let midRate;
            const tolerance = 0.01;
            const maxIterations = 100;
            
            for (let iteration = 0; iteration < maxIterations; iteration++) {
                midRate = (lowRate + highRate) / 2;
                
                // Calculate IRR at this rate
                const oldPayment = calculateMonthlyPayment(currentBalance, currentRate, yearsRemaining * 12);
                const refinancingCosts = currentBalance * (originationFee + points);
                const prepaymentPenaltyCost = currentBalance * currentPrepaymentPenalty;
                const totalUpfrontCosts = refinancingCosts + prepaymentPenaltyCost;
                
                const newPayment = calculateMonthlyPayment(currentBalance, midRate, newTermYears * 12);
                const monthlySavings = oldPayment - newPayment;
                
                const oldBalanceAtEnd = calculateRemainingBalance(currentBalance, currentRate, yearsRemaining * 12, holdingPeriod * 12);
                const newBalanceAtEnd = calculateRemainingBalance(currentBalance, midRate, newTermYears * 12, holdingPeriod * 12);
                
                const cashFlows = [-totalUpfrontCosts];
                for (let i = 0; i < holdingPeriod * 12; i++) {
                    cashFlows.push(monthlySavings);
                }
                cashFlows[cashFlows.length - 1] += (oldBalanceAtEnd - newBalanceAtEnd);
                
                const irr = calculateIRR(cashFlows);
                
                if (irr === null) {
                    // Can't calculate IRR at this rate, likely too high
                    highRate = midRate;
                    continue;
                }
                
                if (Math.abs(irr - targetIRR) < tolerance) {
                    return midRate;
                }
                
                if (irr > targetIRR) {
                    // IRR is too high, need a higher interest rate to bring it down
                    lowRate = midRate;
                } else {
                    // IRR is too low, need a lower interest rate to bring it up
                    highRate = midRate;
                }
            }
            
            return midRate;
        }
        
        function calculateRefinance() {
            const currentBalance = parseFloat(document.getElementById('currentBalance').value);
            const currentRate = parseFloat(document.getElementById('currentRate').value);
            const yearsRemaining = parseFloat(document.getElementById('yearsRemaining').value);
            const currentPrepaymentPenalty = parseFloat(document.getElementById('currentPrepaymentPenalty').value) / 100;
            
            const newRate = parseFloat(document.getElementById('newRate').value);
            const newTerm = parseFloat(document.getElementById('newTerm').value);
            const originationFee = parseFloat(document.getElementById('originationFee').value) / 100;
            const points = parseFloat(document.getElementById('points').value) / 100;
            
            const holdingPeriod = parseFloat(document.getElementById('holdingPeriod').value);
            const riskFreeRate = parseFloat(document.getElementById('riskFreeRate').value);
            
            if (isNaN(currentBalance) || isNaN(currentRate) || isNaN(yearsRemaining) || 
                isNaN(newRate) || isNaN(newTerm) || isNaN(holdingPeriod)) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Show loading indicator for break-even calculation
            document.getElementById('loading').classList.add('show');
            
            const oldPayment = calculateMonthlyPayment(currentBalance, currentRate, yearsRemaining * 12);
            
            const refinancingCosts = currentBalance * (originationFee + points);
            const prepaymentPenaltyCost = currentBalance * currentPrepaymentPenalty;
            const totalUpfrontCosts = refinancingCosts + prepaymentPenaltyCost;
            
            const newPayment = calculateMonthlyPayment(currentBalance, newRate, newTerm * 12);
            const monthlySavings = oldPayment - newPayment;
            
            const oldBalanceAtEnd = calculateRemainingBalance(currentBalance, currentRate, yearsRemaining * 12, holdingPeriod * 12);
            const newBalanceAtEnd = calculateRemainingBalance(currentBalance, newRate, newTerm * 12, holdingPeriod * 12);
            
            const cashFlows = [-totalUpfrontCosts];
            for (let i = 0; i < holdingPeriod * 12; i++) {
                cashFlows.push(monthlySavings);
            }
            // Add the difference in remaining balances to the last cash flow
            cashFlows[cashFlows.length - 1] += (oldBalanceAtEnd - newBalanceAtEnd);
            
            const irr = calculateIRR(cashFlows);
            
            // Calculate NPV
            let npv = -totalUpfrontCosts;
            const monthlyDiscountRate = riskFreeRate / 100 / 12;
            for (let i = 1; i <= holdingPeriod * 12; i++) {
                if (i < holdingPeriod * 12) {
                    npv += monthlySavings / Math.pow(1 + monthlyDiscountRate, i);
                } else {
                    npv += (monthlySavings + oldBalanceAtEnd - newBalanceAtEnd) / Math.pow(1 + monthlyDiscountRate, i);
                }
            }
            
            // Calculate break-even rates for 15 and 30 year loans
            setTimeout(() => {
                const breakEven15 = calculateBreakEvenRate(
                    currentBalance, currentRate, yearsRemaining, 15,
                    originationFee, points, currentPrepaymentPenalty,
                    holdingPeriod, riskFreeRate
                );
                
                const breakEven30 = calculateBreakEvenRate(
                    currentBalance, currentRate, yearsRemaining, 30,
                    originationFee, points, currentPrepaymentPenalty,
                    holdingPeriod, riskFreeRate
                );
                
                // Hide loading indicator
                document.getElementById('loading').classList.remove('show');
                
                // Improved decision logic
                let shouldRefinance = false;
                let decisionReason = '';
                
                if (monthlySavings < 0 && npv < 0) {
                    shouldRefinance = false;
                    decisionReason = 'higher_payment_negative_npv';
                } else if (npv < 0) {
                    shouldRefinance = false;
                    decisionReason = 'negative_npv';
                } else if (irr === null) {
                    shouldRefinance = false;
                    decisionReason = 'invalid_cash_flows';
                } else if (irr < 0) {
                    shouldRefinance = false;
                    decisionReason = 'negative_irr';
                } else if (irr < riskFreeRate) {
                    shouldRefinance = false;
                    decisionReason = 'irr_below_benchmark';
                } else if (irr >= riskFreeRate && npv > 0) {
                    shouldRefinance = true;
                    decisionReason = 'both_conditions_met';
                } else {
                    shouldRefinance = false;
                    decisionReason = 'other';
                }
                
                displayResults({
                    oldPayment,
                    newPayment,
                    monthlySavings,
                    totalUpfrontCosts,
                    prepaymentPenaltyCost,
                    refinancingCosts,
                    irr,
                    npv,
                    riskFreeRate,
                    shouldRefinance,
                    decisionReason,
                    oldBalanceAtEnd,
                    newBalanceAtEnd,
                    holdingPeriod,
                    breakEven15,
                    breakEven30,
                    currentBalance,
                    originationFee: originationFee * 100,
                    points: points * 100
                });
            }, 100);
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');
            
            const decisionClass = results.shouldRefinance ? 'good' : 'bad';
            const decisionText = results.shouldRefinance ? 
                '‚úÖ REFINANCING IS RECOMMENDED' : 
                '‚ùå REFINANCING IS NOT RECOMMENDED';
            
            const irrDisplay = results.irr === null ? 
                '<span style="color: #eb3349;">Cannot Calculate</span>' : 
                results.irr < 0 ?
                `<span style="color: #eb3349;">${results.irr.toFixed(2)}%</span>` :
                `${results.irr.toFixed(2)}%`;
            
            // Generate detailed explanation based on decision reason
            let detailedExplanation = '';
            switch(results.decisionReason) {
                case 'higher_payment_negative_npv':
                    detailedExplanation = `Your new monthly payment ($${results.newPayment.toFixed(2)}) would be HIGHER than your current payment ($${results.oldPayment.toFixed(2)}) by $${Math.abs(results.monthlySavings).toFixed(2)} per month. Additionally, the NPV is negative ($${results.npv.toFixed(2)}), meaning you would lose money overall. This is clearly not beneficial.`;
                    break;
                case 'negative_npv':
                    detailedExplanation = `The Net Present Value is negative ($${results.npv.toFixed(2)}), meaning the total costs of refinancing ($${results.totalUpfrontCosts.toFixed(2)}) outweigh the benefits over your ${results.holdingPeriod}-year holding period. You would lose money by refinancing.`;
                    break;
                case 'invalid_cash_flows':
                    detailedExplanation = `The cash flow structure does not allow for a meaningful IRR calculation. This typically happens when all cash flows are negative (you're paying more with no savings) or when the upfront costs are too high relative to the savings.`;
                    break;
                case 'negative_irr':
                    detailedExplanation = `The Internal Rate of Return is negative (${results.irr.toFixed(2)}%), which means you would be losing money on this refinancing decision. The costs significantly outweigh any potential benefits.`;
                    break;
                case 'irr_below_benchmark':
                    detailedExplanation = `While the IRR is positive (${results.irr.toFixed(2)}%), it's below your benchmark rate of ${results.riskFreeRate.toFixed(2)}%. You could get better returns by investing your money elsewhere with less risk.`;
                    break;
                case 'both_conditions_met':
                    detailedExplanation = `Excellent opportunity! Your IRR of ${results.irr.toFixed(2)}% exceeds the benchmark rate of ${results.riskFreeRate.toFixed(2)}%, and your NPV is positive at $${results.npv.toFixed(2)}. You'll save $${results.monthlySavings.toFixed(2)} per month after paying $${results.totalUpfrontCosts.toFixed(2)} in upfront costs.`;
                    break;
                default:
                    detailedExplanation = `Based on the analysis, refinancing is not recommended. Consider the costs versus benefits carefully.`;
            }
            
            resultsContent.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Current Monthly Payment</span>
                    <span class="result-value">$${results.oldPayment.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">New Monthly Payment</span>
                    <span class="result-value">$${results.newPayment.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Monthly Savings</span>
                    <span class="result-value" style="color: ${results.monthlySavings >= 0 ? '#11998e' : '#eb3349'}">
                        ${results.monthlySavings >= 0 ? '$' : '-$'}${Math.abs(results.monthlySavings).toFixed(2)}
                    </span>
                </div>
                <div class="result-item">
                    <span class="result-label">Total Upfront Costs</span>
                    <span class="result-value">$${results.totalUpfrontCosts.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Internal Rate of Return (IRR)</span>
                    <span class="result-value">${irrDisplay}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Net Present Value (NPV)</span>
                    <span class="result-value" style="color: ${results.npv >= 0 ? '#11998e' : '#eb3349'}">
                        $${results.npv.toFixed(2)}
                    </span>
                </div>
                <div class="result-item">
                    <span class="result-label">Benchmark Rate</span>
                    <span class="result-value">${results.riskFreeRate.toFixed(2)}%</span>
                </div>
                <div class="decision-box ${decisionClass}">
                    ${decisionText}
                </div>
                <div class="info-box" style="margin-top: 20px; background: white; border-left: 4px solid #667eea;">
                    <h3 style="color: #667eea;">üìä Analysis Summary</h3>
                    <p style="color: #333;">${detailedExplanation}</p>
                </div>
            `;
            
            resultsDiv.classList.add('show');
            
            // Display break-even analysis
            displayBreakEvenAnalysis(results);
        }
        
        function displayBreakEvenAnalysis(results) {
            const breakevenSection = document.getElementById('breakevenSection');
            const breakeven15Content = document.getElementById('breakeven15Content');
            const breakeven30Content = document.getElementById('breakeven30Content');
            
            document.getElementById('benchmarkRateDisplay').textContent = `${results.riskFreeRate.toFixed(2)}%`;
            
            // Calculate monthly payments at break-even rates
            const payment15 = calculateMonthlyPayment(results.currentBalance, results.breakEven15, 15 * 12);
            const payment30 = calculateMonthlyPayment(results.currentBalance, results.breakEven30, 30 * 12);
            
            breakeven15Content.innerHTML = `
                <div class="rate-highlight">
                    <div class="label">Maximum Acceptable Rate</div>
                    <div class="rate">${results.breakEven15.toFixed(3)}%</div>
                </div>
                <div class="breakeven-detail">
                    <span class="breakeven-label">Monthly Payment at Break-Even</span>
                    <span class="breakeven-value">$${payment15.toFixed(2)}</span>
                </div>
                <div class="breakeven-detail">
                    <span class="breakeven-label">Origination Fee</span>
                    <span class="breakeven-value">${results.originationFee.toFixed(1)}%</span>
                </div>
                <div class="breakeven-detail">
                    <span class="breakeven-label">Discount Points</span>
                    <span class="breakeven-value">${results.points.toFixed(1)}%</span>
                </div>
                <div class="breakeven-detail">
                    <span class="breakeven-label">Total Closing Costs</span>
                    <span class="breakeven-value">$${(results.currentBalance * (results.originationFee + results.points) / 100).toFixed(2)}</span>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 5px;">
                    <small style="color: #0277bd;">
                        üí° If you can get a 15-year loan at ${results.breakEven15.toFixed(3)}% or lower, refinancing will meet your ${results.riskFreeRate.toFixed(2)}% return target.
                    </small>
                </div>
            `;
            
            breakeven30Content.innerHTML = `
                <div class="rate-highlight">
                    <div class="label">Maximum Acceptable Rate</div>
                    <div class="rate">${results.breakEven30.toFixed(3)}%</div>
                </div>
                <div class="breakeven-detail">
                    <span class="breakeven-label">Monthly Payment at Break-Even</span>
                    <span class="breakeven-value">$${payment30.toFixed(2)}</span>
                </div>
                <div class="breakeven-detail">
                    <span class="breakeven-label">Origination Fee</span>
                    <span class="breakeven-value">${results.originationFee.toFixed(1)}%</span>
                </div>
                <div class="breakeven-detail">
                    <span class="breakeven-label">Discount Points</span>
                    <span class="breakeven-value">${results.points.toFixed(1)}%</span>
                </div>
                <div class="breakeven-detail">
                    <span class="breakeven-label">Total Closing Costs</span>
                    <span class="breakeven-value">$${(results.currentBalance * (results.originationFee + results.points) / 100).toFixed(2)}</span>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 5px;">
                    <small style="color: #0277bd;">
                        üí° If you can get a 30-year loan at ${results.breakEven30.toFixed(3)}% or lower, refinancing will meet your ${results.riskFreeRate.toFixed(2)}% return target.
                    </small>
                </div>
            `;
            
            breakevenSection.classList.add('show');
            breakevenSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function resetForm() {
            document.querySelectorAll('input').forEach(input => {
                if (input.id === 'originationFee') {
                    input.value = '1';
                } else if (input.id === 'currentPrepaymentPenalty' || input.id === 'points') {
                    input.value = '0';
                } else {
                    input.value = '';
                }
            });
            document.getElementById('results').classList.remove('show');
            document.getElementById('breakevenSection').classList.remove('show');
            document.getElementById('loading').classList.remove('show');
        }
    </script>
</body>
</html>